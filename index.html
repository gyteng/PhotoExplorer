<!DOCTYPE html>
<html ng-app="photo">
<head>
    <title>Photo Explorer</title>
    <script src="./server.js"></script>
    <script src="./autoUpdate.js"></script>
    <link rel="stylesheet" href="./bower_components/components-font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./bower_components/ngDialog/css/ngDialog.min.css">
    <script src="./bower_components/angularjs/angular.min.js"></script>
    <script src="./bower_components/angular-ui-router/release/angular-ui-router.min.js"></script>
    <script src="./bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js"></script>
    <script src="./bower_components/ngDialog/js/ngDialog.min.js"></script>
    <script src="./bower_components/angular-touch/angular-touch.min.js"></script>
    <script src="./bower_components/angular-animate/angular-animate.min.js"></script>
    <style type="text/css">
        .box {
            z-index: -1000;
            position: absolute;
            left: 0px;
            top: 0px;

            width: 1280px;
            height: 800px;

            background: #000000;

            -webkit-transition: all linear 0.25s;
            transition: all linear 0.25s;
            line-height: 20px;
            opacity: 1;
        }
        .box.ng-hide {
            line-height: 0;
            opacity: 0;
            padding: 0 0px;
            background: #000000;
        }
        .gallery {
            z-index: -1000;
            position: absolute;
            left: 0px;
            top: 0px;

            width: 1280px;
            height: 800px;

            background: #000000;

            -webkit-transition: all linear 0.3s;
            transition: all linear 0.3s;
            line-height: 20px;
            opacity: 1;
        }
        .gallery.ng-hide {
            line-height: 0;
            opacity: 0;
            padding: 0 0px;
            background: #000000;
        }
        .check-element {
            padding: 0px;
            background: #000000;
        }
    </style>
</head>
<body style="overflow: hidden;">
    <div ui-view></div>
</body>

<script>
// 'use strict';
    // "window": {
    //     "fullscreen": true,
    //     "toolbar":false,
    //     "frame":false
    // }

var app = angular.module('photo', ['ui.bootstrap', 'ngDialog', 'ui.router', 'ngTouch', 'ngAnimate']);
app.config(function($stateProvider, $urlRouterProvider) {
    $urlRouterProvider.otherwise("/photo");
    $stateProvider
        .state('photo', {
            url: "/photo",
            templateUrl: "./pages/photo.html",
            controller: "PhotoController"
        })
        .state('settings', {
            url: "/settings",
            templateUrl: "./pages/settings.html",
            controller: "SettingController"
        })
        .state('gallery', {
            url: "/gallery",
            templateUrl: "./pages/gallery.html",
            controller: "GalleryController"
        })
    ;
});
app.directive('imageonload', function() {
    return {
        restrict: 'A',
        link: function(scope, element, attrs) {
            element.bind('load', function() {
                scope.$apply(attrs.imageonload);
            });
        }
    };
});
app.controller('PhotoController', function($scope, $interval, $timeout, $state, $window) {
    if(!localStorage.getItem('currPicNum')) {
        localStorage.setItem('currPicNum', '0');
    }
    if(!window.files) {
        $scope.fileName = localStorage.getItem('currPicName');
    } else {
        $scope.fileName = window.files[+localStorage.getItem('currPicNum')];
    }
    if(localStorage.getItem('pageTime')) {
        $scope.pageTime = (+localStorage.getItem('pageTime'))*1000;
    } else {
        localStorage.setItem('pageTime', '5');
        $scope.pageTime = 5000;
    }
    
    var img = {};
    $scope.imgStyle = {};

    $interval(function() {
        if(localStorage.getItem('play') === 'true' && $state.is('photo') && window.files && window.files.length > 0) {
            $scope.nextPhoto();
        }
    }, $scope.pageTime);

    $scope.nextPhoto = function() {
        console.log(localStorage.getItem('currPicNum'));
        $scope.hidePic = true;
        $timeout(function() {$scope.hidePic = false;}, 500);
        $timeout(function() {
            var i;
            if (localStorage.getItem('isRandom') === 'true') {
                i = parseInt(Math.random() * 12345) % window.files.length;
                if(+localStorage.getItem('currPicNum') === i) {
                    i = (window.files.length - 1 > i) ? i + 1 : 0;
                }
            } else {
                i = ((window.files.length === (+localStorage.getItem('currPicNum')) + 1) ? 0 : (+localStorage.getItem('currPicNum') + 1));
            }
            $scope.fileName = window.files[i];
            localStorage.setItem('currPicNum', i + '');
            localStorage.setItem('currPicName', window.files[i]);
        }, 250);
    };

    $scope.playAndPauseClass = ((localStorage.getItem('play') === 'true') ? 'fa fa-pause fa-4x fa-fw' : 'fa fa-play fa-4x fa-fw');
    $scope.playAndPause = function() {
        if(localStorage.getItem('play') === 'true') {
            $scope.playAndPauseClass = 'fa fa-play fa-4x fa-fw';
            localStorage.setItem('play', 'false');
            $interval.cancel();
        } else {
            $scope.playAndPauseClass = 'fa fa-pause fa-4x fa-fw';
            localStorage.setItem('play', 'true');
        }
    };

    $scope.imageOnLoad = function() {
        img = {
            naturalWidth: document.getElementById('currPic').naturalWidth,
            naturalHeight: document.getElementById('currPic').naturalHeight
        };
        if (img.naturalWidth / img.naturalHeight > 1.6) {
            $scope.imgStyle.width = '1280px';
            $scope.imgStyle.height = img.naturalHeight / img.naturalWidth * 1280 + 'px';
            $scope.imgStyle['margin-left'] = '0px';
            $scope.imgStyle['margin-right'] = '0px';
            $scope.imgStyle['margin-top'] = (800 - img.naturalHeight / img.naturalWidth * 1280) / 2 + 'px';
            $scope.imgStyle['margin-bottom'] = (800 - img.naturalHeight / img.naturalWidth * 1280) / 2 + 'px';
        } else {
            $scope.imgStyle.width = img.naturalWidth / img.naturalHeight * 800 + 'px';
            $scope.imgStyle.height = '800px';
            $scope.imgStyle['margin-left'] = (1280 - img.naturalWidth / img.naturalHeight * 800) / 2 + 'px';
            $scope.imgStyle['margin-right'] = (1280 - img.naturalWidth / img.naturalHeight * 800) / 2 + 'px';
            $scope.imgStyle['margin-top'] = '0px';
            $scope.imgStyle['margin-bottom'] = '0px';
        }
    };
    $scope.settings = function() {
        $state.go('settings');
    };
    $scope.toGallery = function() {
        $state.go('gallery');
    };
}).controller('SettingController', function($scope, $state, $window) {
    $scope.version = $window.currVersion;
    $scope.randomClass = ((localStorage.getItem('isRandom') === 'true') ? 'fa fa-check-square-o fa-4x fa-fw' : 'fa fa-square-o fa-4x fa-fw');
    $scope.random = function() {
        if(localStorage.getItem('isRandom') === 'true') {
            $scope.randomClass = 'fa fa-square-o fa-4x fa-fw';
            localStorage.setItem('isRandom', 'false');
        } else {
            $scope.randomClass = 'fa fa-check-square-o fa-4x fa-fw';
            localStorage.setItem('isRandom', 'true');
        }
    };
    $scope.home = function() {
        $state.go('photo');
    };
    $scope.exit = function() {
        var gui = require('nw.gui');
        var process = require('child_process');
        process.exec('explorer');
        gui.App.quit();
    };

    $scope.setPageTime = function(time) {
        localStorage.setItem('pageTime', time + '');
        setClass(time);
    };
    $scope.pageTime = [{
        time: 5,
        class: 'fa fa-circle-o fa-2x fa-fw'
    }, {
        time: 15,
        class: 'fa fa-circle-o fa-2x fa-fw'
    }, {
        time: 30,
        class: 'fa fa-circle-o fa-2x fa-fw'
    }, {
        time: 60,
        class: 'fa fa-circle-o fa-2x fa-fw'
    }];

    var setClass = function(time) {
        $scope.pageTime.forEach(function(pt) {
            if(pt.time === time) {
                pt.class = 'fa fa-dot-circle-o fa-2x fa-fw';
            } else {
                pt.class = 'fa fa-circle-o fa-2x fa-fw';
            }
        });
    };
    setClass(+localStorage.getItem('pageTime'));
}).controller('GalleryController', function($scope, $state, $window, $timeout) {
    $scope.pages = Math.ceil($window.files.length / 16);
    $scope.currPage = 1;
    $scope.box = [[], [], [], []];
    $scope.$watch('currPage', function() {
        $scope.box = [[], [], [], []];
        $scope.hidePic = true;
        $timeout(function() {
            $scope.hidePic = false;
        }, 100);
        $timeout(function() {
            $window.files.slice($scope.currPage * 16 - 16, $scope.currPage * 16).forEach(function(f) {
                console.log(f);
                if($scope.box[0].length < 4) {$scope.box[0].push({fileName: f}); return;}
                if($scope.box[1].length < 4) {$scope.box[1].push({fileName: f}); return;}
                if($scope.box[2].length < 4) {$scope.box[2].push({fileName: f}); return;}
                if($scope.box[3].length < 4) {$scope.box[3].push({fileName: f}); return;}
            });
        }, 200);
    });
    
    $scope.home = function() {
        $state.go('photo');
    };
    $scope.toPhoto = function(fileName) {
        localStorage.setItem('currPicName', fileName);
        $state.go('photo');
    };
    $scope.previous = function() {
        if($scope.currPage === 1) return;
        $scope.currPage--;
    };
    $scope.next = function() {
        if($scope.currPage === $scope.pages) return;
        $scope.currPage++;
    };
});

</script>
</html>